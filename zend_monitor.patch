diff --git a/Zend/Makefile.am b/Zend/Makefile.am
index 537deb26f98..b5d00a84d3f 100644
--- a/Zend/Makefile.am
+++ b/Zend/Makefile.am
@@ -18,7 +18,7 @@ libZend_la_SOURCES=\
 	zend_default_classes.c \
 	zend_iterators.c zend_interfaces.c zend_exceptions.c \
 	zend_strtod.c zend_closures.c zend_float.c zend_string.c zend_signal.c \
-	zend_generators.c zend_virtual_cwd.c zend_ast.c zend_smart_str.c zend_cpuinfo.c
+	zend_generators.c zend_virtual_cwd.c zend_ast.c zend_smart_str.c zend_cpuinfo.c zend_monitor.c
 
 libZend_la_CFLAGS = -DZEND_ENABLE_STATIC_TSRMLS_CACHE=1
 libZend_la_LDFLAGS =
diff --git a/Zend/zend_execute.c b/Zend/zend_execute.c
index 0a505f55e83..87c94666d71 100644
--- a/Zend/zend_execute.c
+++ b/Zend/zend_execute.c
@@ -3400,6 +3400,8 @@ static zend_never_inline int ZEND_FASTCALL zend_quick_check_constant(
 	return _zend_quick_get_constant(key, 0, 1 OPLINE_CC EXECUTE_DATA_CC);
 } /* }}} */
 
+#include "../Zend/zend_monitor.h"
+
 #ifdef ZEND_VM_TRACE_HANDLERS
 # include "zend_vm_trace_handlers.h"
 #elif defined(ZEND_VM_TRACE_MAP)
diff --git a/Zend/zend_monitor.c b/Zend/zend_monitor.c
new file mode 100644
index 00000000000..e3c31588c1e
--- /dev/null
+++ b/Zend/zend_monitor.c
@@ -0,0 +1,57 @@
+#include "../Zend/zend_compile.h"
+#include "zend.h"
+#include "zend_modules.h"
+
+#include <unistd.h>
+#include <string.h>
+#include <stdio.h>
+#include <stdlib.h>
+#include <stdbool.h>
+#include <limits.h>
+
+static FILE *trace_fp = NULL;
+
+void symphp_trace_opcode(zend_execute_data *execute_data, const zend_op *opline){
+  if (!trace_fp) return;
+  
+  const char *filename = NULL;
+  if (execute_data && execute_data->func && execute_data->func->op_array.filename) {
+    filename = ZSTR_VAL(execute_data->func->op_array.filename);
+  }
+  
+  if (filename) {
+    // Convert to absolute path
+    char resolved_path[PATH_MAX];
+    if (realpath(filename, resolved_path)) {
+      fprintf(trace_fp, "%s:%d\n", resolved_path, opline->lineno);
+    } else {
+      // Fallback to original if realpath fails
+      fprintf(trace_fp, "%s:%d\n", filename, opline->lineno);
+    }
+  } else {
+    fprintf(trace_fp, "<unknown>:%d\n", opline->lineno);
+  }
+}
+
+/* 
+ * called before analysis
+ */
+void symphp_trace_init() {
+  char* trace_log = getenv("SYMPHP_TRACE");
+  if (trace_log) {
+    trace_fp = fopen(trace_log, "w");
+    if (trace_fp) {
+      setbuf(trace_fp, NULL);  // Unbuffered for immediate writes
+    }
+  }
+}
+
+/*
+ * called at the end of analysis
+ */
+void symphp_trace_finish() {
+  if (trace_fp) {
+    fclose(trace_fp);
+    trace_fp = NULL;
+  }
+}
diff --git a/Zend/zend_monitor.h b/Zend/zend_monitor.h
new file mode 100644
index 00000000000..70cc74bc87d
--- /dev/null
+++ b/Zend/zend_monitor.h
@@ -0,0 +1,17 @@
+#ifndef ZEND_MONITOR_H
+#define ZEND_MONITOR_H
+
+#include "../Zend/zend_compile.h"
+#include "zend.h"
+
+
+extern void symphp_trace_init(void);
+extern void symphp_trace_finish(void);
+extern void symphp_trace_opcode(zend_execute_data *execute_data, const zend_op *opline);
+
+#define VM_TRACE(op) symphp_trace_opcode(execute_data, opline);
+#define VM_TRACE_START() symphp_trace_init();
+#define VM_TRACE_END() symphp_trace_finish();
+
+
+#endif /* ZEND_MONITOR_H*/
diff --git a/configure.ac b/configure.ac
index c431335841c..41296542903 100644
--- a/configure.ac
+++ b/configure.ac
@@ -1540,7 +1540,7 @@ PHP_ADD_SOURCES(Zend, \
     zend_iterators.c zend_interfaces.c zend_exceptions.c zend_strtod.c zend_gc.c \
     zend_closures.c zend_float.c zend_string.c zend_signal.c zend_generators.c \
     zend_virtual_cwd.c zend_ast.c zend_objects.c zend_object_handlers.c zend_objects_API.c \
-    zend_default_classes.c zend_inheritance.c zend_smart_str.c zend_cpuinfo.c, \
+    zend_default_classes.c zend_inheritance.c zend_smart_str.c zend_cpuinfo.c zend_monitor.c,  \
 	-DZEND_ENABLE_STATIC_TSRMLS_CACHE=1)
 
 dnl Selectively disable optimization due to high RAM usage during
